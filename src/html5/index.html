<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>

		<!--
			Copyright (c) 2013-2016 Antoine Martin <antoine@devloop.org.uk>
			Copyright (c) 2014 Joshua Higgins <josh@kxes.net>
			Licensed under MPL 2.0
 		-->

		<title>xpra websockets client</title>
		<meta charset="utf-8">
		<meta name="description" content="xpra websockets client">
		<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
		<link rel="icon" type="image/png" href="/favicon.png">

		<link rel="stylesheet" href="css/client.css">
		<link rel="stylesheet" href="css/spinner.css">

		<script type="text/javascript" src="js/lib/jquery.min.js"></script>
		<script type="text/javascript" src="js/lib/jqueryui.min.js"></script>
		<script type="text/javascript" src="js/lib/jquery.throttle-debounce.min.js"></script>

		<script type="text/javascript" src="js/lib/bencode.js"></script>
		<script type="text/javascript" src="js/lib/zlib.js"></script>
		<script type="text/javascript" src="js/lib/lz4.js"></script>
		<script type="text/javascript" src="js/lib/forge.js"></script>

		<script type="text/javascript" src="js/lib/broadway/Decoder.js"></script>
		<script type="text/javascript" src="js/lib/aurora/aurora.js"></script>
		<script type="text/javascript" src="js/lib/aurora/aurora-xpra.js"></script>
		<script type="text/javascript" src="js/lib/aurora/mp3.js"></script>

		<script type="text/javascript" src="js/Keycodes.js"></script>
		<script type="text/javascript" src="js/Protocol.js"></script>
		<script type="text/javascript" src="js/Window.js"></script>
		<script type="text/javascript" src="js/Notifications.js"></script>
		<script type="text/javascript" src="js/Utilities.js"></script>
		<script type="text/javascript" src="js/Client.js"></script>
	</head>

	<body>
		<div id="dpi" style="width: 1in; height: 1in; left: -100%; top: -100%; position: absolute;">
		</div>

		<div id="screen" style="width: 100%; height:100%;">
		</div>

		<div class="notifications">
		</div>

		<input id="pasteboard" onblur="this.focus()" autofocus />

		<script>

			if (!window.location.getParameter ) {
				window.location.getParameter = function(key) {
					function parseParams() {
							var params = {},
									e,
									a = /\+/g,	// Regex for replacing addition symbol with a space
									r = /([^&=]+)=?([^&]*)/g,
									d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
									q = window.location.search.substring(1);
	
							while (e = r.exec(q))
									params[d(e[1])] = d(e[2]);
	
							return params;
					}
	
					if (!this.queryStringParams)
							this.queryStringParams = parseParams();
	
					return this.queryStringParams[key];
				};
			}

			// disable right click menu:
			window.oncontextmenu = function(e) {
				//showCustomMenu();
				return false;
			}

			function getparam(name) {
				return window.location.getParameter(name);
			}

			$(document).ready(function() {

				// look at url parameters
				var username = getparam("username") || null;
				var password = getparam("password") || null;
				var sound = getparam("sound") || null;
				var encoding = getparam("encoding") || null;
				var action = getparam("action") || "connect";
				var submit = getparam("submit") || null;
				var server = getparam("server") || window.location.hostname;
				var port = getparam("port") || window.location.port;
				var encryption = getparam("encryption") || null;
				var key = getparam("key") || null;
				var keyboard_layout = getparam("keyboard_layout") || null;
				var start = getparam("start");
				var exit_with_children = getparam("exit_with_children") || "";
				var exit_with_client = getparam("exit_with_client") || "";
				var normal_fullscreen = getparam("normal_fullscreen") || null;
				var debug = getparam("debug") || false;
				var insecure = getparam("insecure") || null;

				// create the client
				var client = new XpraClient('screen');
				client.debug = debug;

				// the primary encoding can be set
				if(encoding) {
					client.enable_encoding(encoding);
				}
			    // encodings can be disabled like so
			    // client.disable_encoding("h264");
			    if(action && (action!="connect")) {
			    	sns = {
			    			"mode" 	: action,
			    	};
	    			if(start) {
	    				sns["start"] = [start];
	    			}
    				if (exit_with_children) {
    					sns["exit-with-children"] = true;
    				}
    				if (exit_with_client) {
    					sns["exit-with-client"] = true;
    				}
			    	client.start_new_session = sns
			    }

			    // see if we should undecorate and maximise normal windows
			    if(normal_fullscreen) {
			    	client.normal_fullscreen_mode = true;
			    }

			    // experimental sound support
			    if(sound) {
			    	client.audio_enabled = true;
			    }

			    // insecure passwords
			    if(insecure) {
			    	client.insecure = true;
			    }
			    
			    if(keyboard_layout) {
			    	client.keyboard_layout = keyboard_layout;
			    }

			    // check for username and password
			    if(username) {
			    	client.username = username;
			    }
			    if(password) {
			    	client.authentication_key = password;
			    }

			    // check for encryption parameters
			    if(encryption) {
			    	client.encryption = encryption;
			    	if(key) {
			    		client.encryption_key = key;
			    	}
			    }

			    // attach a callback for when client closes
			    if(!debug) {
				    client.callback_close = function(reason) {
				    	if(submit) {
				    		var message = "Connection closed (socket closed)";
				    		if(reason) {
				    			message = reason;
				    		}
				    		window.location="connect.html?disconnect="+message+"&username="+username+"&encoding="+encoding+"&keyboard_layout="+keyboard_layout+"&encoding="+encoding+"&action="+action+"&sound="+sound+"&exit_with_children="+exit_with_children+"&exit_with_client="+exit_with_client+"&normal_fullscreen="+normal_fullscreen;
				    	} else {
					    	// if we didn't submit through the form, silently redirect to the connect gui
					    	window.location="connect.html";
					    }
				    }
				}

			    // and connect
			    client.connect(server, port, false);

			    // attach a callback for paste on the screen
				$('#pasteboard').on('paste', function (e) {
					e.preventDefault();
					var text = (e.originalEvent || e).clipboardData.getData('text/plain');
					client.handle_paste(text);
				});

			    // try to ensure the browser doesn't fire shortcuts
			    // (ie: we want control-S to be sent to the application, not trigger the save-page browser action)
				$(window).bind('keydown', function(event) {
				    if (event.ctrlKey || event.metaKey) {
			            event.preventDefault();
				    }
				});
			});
		</script>
	</body>
</html>
