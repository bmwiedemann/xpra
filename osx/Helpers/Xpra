#!/bin/sh

exe_name=$(basename $0)
full_path=$(cd "$(dirname "$0")"; pwd)

tmp=`dirname "$full_path"`
bundle=`dirname "$tmp"`
bundle_contents="$bundle"/Contents
bundle_res="$bundle_contents"/Resources
bundle_lib="$bundle_res"/lib
bundle_bin="$bundle_res"/bin
bundle_data="$bundle_res"/share
bundle_etc="$bundle_res"/etc

DYLD_LIBRARY_PATH="$bundle_lib"
XDG_CONFIG_DIRS="$bundle_etc"/xdg
XDG_DATA_DIRS="$bundle_data"
GTK_DATA_PREFIX="$bundle_res"
GTK_EXE_PREFIX="$bundle_res"
GTK_PATH="$bundle_res"

GTK2_RC_FILES="$bundle_etc/gtk-2.0/gtkrc"
GTK_IM_MODULE_FILE="$bundle_etc/gtk-2.0/gtk.immodules"
GDK_PIXBUF_MODULE_FILE="$bundle_etc/gtk-2.0/gdk-pixbuf.loaders"
PANGO_RC_FILE="$bundle_etc/pango/pangorc"
PANGO_LIBDIR="$bundle_lib"
PANGO_SYSCONFDIR="$bundle_etc"

GST_PLUGIN_PATH="$bundle_lib/gstreamer-0.10"
GST_PLUGIN_SCANNER="$bundle_contents/Helpers/gst-plugin-scanner"

#Set $PYTHON to point inside the bundle
#This is not the real "python" but a copy of it named "xpra"
#This is hacked together in make-app.sh
PYTHON="$bundle_bin/Xpra"
PYTHONHOME="$bundle_res"
#Add the bundle's python modules
PYTHONPATH="$bundle_lib:$PYTHONPATH"
PYTHONPATH="$bundle_lib/python/lib-dynload/:$PYTHONPATH"
PYTHONPATH="$bundle_lib/python/:$PYTHONPATH"
PYTHONPATH="$bundle_lib/pygtk/2.0:$PYTHONPATH"

# We need a UTF-8 locale.
lang=`defaults read .GlobalPreferences AppleLocale 2>/dev/null`
if test "$?" != "0"; then
	lang=`defaults read .GlobalPreferences AppleCollationOrder 2>/dev/null | sed 's/_.*//'`
fi
LANG=""
if test "$lang" != ""; then
	LANG="`grep \"\`echo $lang\`_\" /usr/share/locale/locale.alias | \
		tail -n1 | sed 's/\./ /' | awk '{print $2}'`"
fi
if test "$LANG" == ""; then
	LANG="C"
else
	LANG="$LANG.utf8"
fi

if test -f "$bundle_lib/charset.alias"; then
    CHARSETALIASDIR="$bundle_lib"
fi

# Extra arguments can be added in environment.sh.
EXTRA_ARGS=
if test -f "$bundle_res/environment.sh"; then
  source "$bundle_res/environment.sh"
fi


args="[\"xpra\""
while (($#)); do
    args="$args,\"$1\""
    shift
done
args="$args]"

exec "$PYTHON" -c "import sys;sys.argv[0]=\"$full_path/$exe_name\";from xpra.scripts.main import main;main('xpra', $args)"
